<!DOCTYPE html>
<html>
<head>
    <title>Sheet View</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        /* Prevent layout shifts */
        body {
            margin: 0;
            padding: 0;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            overflow-x: hidden;  /* Prevent horizontal scrollbar jumps */
        }

        table {
            border-collapse: collapse;
            width: 100%;
            font-size: 14px;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, sans-serif;
            border: 1px solid #e0e0e0;
            table-layout: fixed;
            position: relative;
        }
        
        th, td {
            border: 1px solid #e0e0e0;
            padding: 8px;
            text-align: left;
            height: 40px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        th {
            background-color: white;
            color: #333333;
            font-weight: 600;
            padding: 16px;
            height: 60px;
            font-size: 15px;
            position: sticky;
            top: 0;
            z-index: 10;
            background: #f8f9fa;
            border-bottom: 2px solid #e0e0e0;
        }

        /* Column separators */
        td:not(:last-child), th:not(:last-child) {
            border-right: 1px solid #e0e0e0;
        }

        /* Row separators */
        tr:not(:last-child) td {
            border-bottom: 1px solid #e0e0e0;
        }
        
        tr:hover {
            background-color: #f8f9fa;
        }

        .editable {
            cursor: pointer;
            transition: background-color 0.2s;
            position: relative;
            padding: 8px 12px;
            box-sizing: border-box;
            height: 40px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            background: white;
        }

        .editable:hover {
            background-color: #f5f5f5;
        }

        .editable.editing {
            padding: 8px 12px;
            outline: 2px solid #4285f4;
            outline-offset: -2px;
            background: white;
            z-index: 2;
        }

        .editable.editing input {
            margin: 0;
            padding: inherit;
            border: none;
            outline: none;
            background: white;
            font: inherit;
            color: inherit;
            width: 100%;
            height: 100%;
        }

        .editable.editing:hover {
            background: white;
        }

        .bottom-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-top: 1px solid #e0e0e0;
            padding: 0;
            display: flex;
            align-items: center;
            gap: 0;
            z-index: 900;
            height: 40px;
            box-shadow: 0 -1px 2px rgba(0,0,0,0.05);
            backdrop-filter: blur(8px);
            background: white;
            min-width: min-content;  /* Prevent wrapping */
        }

        .sheet-tab {
            padding: 0 20px;
            border: none;
            border-radius: 4px 4px 0 0;
            background: transparent;
            cursor: pointer;
            font-size: 13px;
            color: #3c4043;
            font-weight: 500;
            height: 40px;
            display: flex;
            align-items: center;
            transition: all 0.2s;
            user-select: none;
            position: relative;
            min-width: 80px;
            justify-content: center;
        }

        .sheet-tab.active {
            background: white;
            color: #1a73e8;
            font-weight: 600;
            border: 1px solid #e0e0e0;
            border-top: 3px solid #1a73e8;
            border-bottom: none;
            height: 41px;
            margin-top: -1px;
        }

        .sheet-tab:hover:not(.active) {
            background: #f8f9fa;
            color: #202124;
        }

        .sheet-menu {
            position: absolute;
            left: 0;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-shadow: 0 2px 6px rgba(60, 64, 67, 0.15);
            display: none;
            min-width: 200px;
            z-index: 1100;
            padding: 4px 0;
            font-size: 13px;
        }

        .sheet-menu-item {
            padding: 5px 36px 5px 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            color: #3c4043;
            white-space: nowrap;
            position: relative;
            height: 32px;
        }

        .sheet-menu-item:hover {
            background-color: #f1f3f4;
        }

        .sheet-menu-item:hover::after {
            content: '';  /* Remove keyboard shortcuts */
            position: absolute;
            right: 16px;
            color: #5f6368;
            font-size: 12px;
        }

        .sheet-menu-item span {
            opacity: 0.87;
        }

        /* Divider between menu items */
        .sheet-menu-divider {
            height: 1px;
            background-color: #e0e0e0;
            margin: 4px 0;
        }

        .rename-input {
            width: 100%;
            padding: 6px 8px;
            border: 2px solid #1a73e8;
            border-radius: 4px;
            font-size: 13px;
            outline: none;
            margin: 0;
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            box-sizing: border-box;
            z-index: 1101;
            background: white;
        }

        .sheet-menu-item.danger {
            color: #d93025;
        }

        .new-sheet-btn {
            padding: 0 16px;
            color: #1a73e8;
            background: transparent;
            border: none;
            cursor: pointer;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 4px;
            height: 40px;
            border-radius: 0;
            margin-left: 0;
            font-weight: 500;
            border-left: 1px solid #f1f3f4;
            flex-shrink: 0;  /* Prevent button from shrinking */
            position: sticky;
            right: 0;
            background: white;  /* Cover overflow content */
        }

        .new-sheet-btn:hover {
            background: #f8f9fa;
        }

        /* Table container */
        .table-container {
            margin: 20px;
            margin-bottom: 80px;
            overflow-x: auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            padding: 0;
            border: 1px solid #e0e0e0;
            flex: 1;
            position: relative;
            height: calc(100vh - 100px);
            -webkit-overflow-scrolling: touch;  /* Smooth scrolling on iOS */
        }

        .button {
            padding: 8px 16px;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
        }

        .delete-button {
            background-color: transparent;
            border: 1px solid #d93025;
            color: #d93025;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s;
        }

        .delete-button:hover {
            background-color: #d93025;
            color: white;
        }

        /* Update the table cell styling */
        td:last-child {
            text-align: center;
            padding: 4px 8px;
        }

        /* Column-specific styles */
        td:nth-child(1) {  /* Test Case ID */
            color: #1967d2;
            font-weight: 500;
        }

        td:nth-child(6) {  /* Priority */
            font-weight: 500;
        }

        td:nth-child(8) {  /* Status */
            font-weight: 500;
        }

        td:nth-child(10) {  /* Test Result */
            font-weight: 500;
        }

        /* Input styling */
        input {
            font-family: inherit;
            font-size: inherit;
            padding: 8px 11px;  /* Account for border */
            border: none;
            outline: none;
            width: 100%;
            height: 100%;
            background: transparent;
            box-sizing: border-box;
            color: #202124;
            margin: 0;
            position: relative;
        }

        /* Color menu styles */
        .color-menu {
            position: absolute;
            background: white;
            border: 1px solid #e1e1e1;
            border-radius: 4px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            padding: 8px;
            display: none;
            z-index: 1000;
            transform: translateZ(0);  /* Force GPU acceleration */
        }

        .color-option {
            width: 24px;
            height: 24px;
            border-radius: 4px;
            margin: 4px;
            cursor: pointer;
            border: 1px solid #e1e1e1;
            display: inline-block;
            transition: transform 0.2s;
        }

        .color-option:hover {
            transform: scale(1.1);
        }

        /* Predefined cell background colors */
        .bg-red {
            background-color: #fce8e8 !important;
            color: #d93025;
        }

        .bg-green {
            background-color: #e6f4ea !important;
            color: #137333;
        }

        .bg-yellow {
            background-color: #fef7e0 !important;
            color: #b06000;
        }

        .bg-blue {
            background-color: #e8f0fe !important;
            color: #1967d2;
        }

        /* Set specific widths for columns to prevent jumping */
        th:nth-child(1) { width: 50px; }    /* Row number */
        th:nth-child(2) { width: 150px; }   /* Test Case ID */
        th:nth-child(3) { width: 180px; }   /* Module */
        th:nth-child(4) { width: 300px; }   /* Test Case */
        th:nth-child(5) { width: 300px; }   /* Expected Outcome */
        th:nth-child(6) { width: 300px; }   /* Actual Outcome */
        th:nth-child(7) { width: 120px; }   /* Priority */
        th:nth-child(8) { width: 150px; }   /* Assigned To */
        th:nth-child(9) { width: 120px; }   /* Status */
        th:nth-child(10) { width: 150px; }  /* Execution Date */
        th:nth-child(11) { width: 120px; }  /* Test Result */
        th:nth-child(12) { width: 250px; }  /* Comments */
        th:nth-child(13) { width: 100px; }  /* Actions */

        /* Update cell styling */
        td, th {
            padding: 12px 16px;
            font-size: 15px;
            line-height: 1.5;
        }

        /* Make test case related columns more prominent */
        td:nth-child(4), /* Test Case */
        td:nth-child(5), /* Expected Outcome */
        td:nth-child(6)  /* Actual Outcome */ {
            font-size: 15px;
            line-height: 1.6;
            padding: 16px;
            white-space: pre-wrap; /* Allow line breaks */
            min-height: 60px;
        }

        /* Make headers more visible */
        th {
            font-size: 15px;
            font-weight: 600;
            padding: 16px;
            height: 60px;
        }

        /* Improve readability of cells */
        .editable {
            background: white;
            transition: all 0.2s;
        }

        .editable:hover {
            background: #f8f9fa;
            box-shadow: 0 0 0 2px #e8f0fe;
        }

        /* Remove column-specific styles for cells */
        td:nth-child(1), td:nth-child(6), td:nth-child(8), td:nth-child(10) {
            font-weight: normal;
            color: inherit;
        }

        /* End of table indicator */
        .end-of-table {
            text-align: center;
            padding: 20px;
            color: #666;
            background: #f8f9fa;
            border-top: 1px solid #e0e0e0;
            font-size: 13px;
        }

        /* Update hover effect */
        tr:hover td {
            background-color: #f8f9fa;
            transition: background-color 0.2s;
        }

        td {
            color: #202124;
            background: white;
        }

        th {
            background-color: white;
            color: #333333;
            font-weight: 600;
        }

        /* Ensure header text is vertically centered */
        th {
            vertical-align: middle;
        }

        /* Container for sheet tabs */
        .sheets-container {
            display: flex;
            align-items: flex-end;
            height: 40px;
            gap: 0;
            margin-left: 0;
            padding-right: 16px;
            border-right: 1px solid #f1f3f4;
            overflow-x: auto;
            overflow-y: hidden;
            flex: 1;  /* Take remaining space */
        }

        /* Hide scrollbar but keep functionality */
        .sheets-container::-webkit-scrollbar {
            display: none;
        }

        /* Update hamburger menu styles */
        .sheet-hamburger {
            padding: 8px 12px;
            cursor: pointer;
            margin-right: 0;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            height: 40px;
            border-right: 1px solid #e0e0e0;
        }

        .sheet-hamburger:hover {
            background-color: #f1f3f4;
        }

        .sheet-hamburger-icon {
            width: 18px;
            height: 12px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            gap: 4px;
        }

        .sheet-hamburger-icon span {
            display: block;
            width: 18px;
            height: 2px;
            background-color: #5f6368;
            border-radius: 1px;
        }

        /* Worksheet menu styles */
        .worksheet-menu {
            position: absolute;
            background: white;
            border: 1px solid #dadce0;
            border-radius: 4px;
            box-shadow: 0 2px 6px rgba(60, 64, 67, 0.15);
            min-width: 240px;
            z-index: 1100;
            padding: 8px 0;
            font-size: 13px;
            max-height: 70vh;
            overflow-y: auto;
        }

        .worksheet-menu-item {
            padding: 0 24px 0 42px;
            cursor: pointer;
            color: #3c4043;
            display: flex;
            align-items: center;
            height: 32px;
            position: relative;
        }

        .worksheet-menu-item.active {
            background-color: #e8f0fe;
            color: #1a73e8;
        }

        .worksheet-menu-item.active::after {
            content: '✓';
            position: absolute;
            left: 16px;
            color: #1a73e8;
        }

        .worksheet-menu-item:hover {
            background-color: #f1f3f4;
        }

        /* Add styles for drag handle and selection */
        .editable {
            position: relative;
        }

        .drag-handle {
            position: absolute;
            width: 8px;
            height: 8px;
            background: #1a73e8;
            right: -4px;
            bottom: -4px;
            cursor: crosshair;
            border-radius: 2px;
            display: none;
            z-index: 100;
        }

        .editable.selected {
            outline: 2px solid #1a73e8;
            outline-offset: -2px;
        }

        .editable.selected .drag-handle {
            display: block;
        }

        .cell-selection {
            position: absolute;
            background: rgba(26, 115, 232, 0.1);
            border: 2px solid #1a73e8;
            pointer-events: none;
            z-index: 99;
        }

        /* Header text colors with better contrast */
        th:nth-child(1) { /* Row number */
            background: #f8f9fa;
            color: #202124;
            font-weight: 600;
        }
        th:nth-child(2) { /* Test Case ID */
            color: #1967D2;
            background: #E8F0FE;
        }
        th:nth-child(3) { /* Module */
            color: #188038;
            background: #E6F4EA;
        }
        th:nth-child(4) { /* Test Case */
            color: #1967D2;
            background: #E8F0FE;
        }
        th:nth-child(5) { /* Expected Outcome */
            color: #188038;
            background: #E6F4EA;
        }
        th:nth-child(6) { /* Actual Outcome */
            color: #D93025;
            background: #FCE8E6;
            font-weight: 700;
        }
        th:nth-child(7) { /* Priority */
            color: #D93025;
            background: #FCE8E6;
        }
        th:nth-child(8) { /* Assigned To */
            color: #1967D2;
            background: #E8F0FE;
        }
        th:nth-child(9) { /* Status */
            color: #188038;
            background: #E6F4EA;
        }
        th:nth-child(10) { /* Execution Date */
            color: #D93025;
            background: #FCE8E6;
        }
        th:nth-child(11) { /* Test Result */
            color: #188038;
            background: #E6F4EA;
        }
        th:nth-child(12) { /* Comments */
            color: #1967D2;
            background: #E8F0FE;
        }
        th:nth-child(13) { /* Actions */
            color: #5F6368;
            background: #F8F9FA;
        }

        /* Add subtle hover effect to headers */
        th:hover {
            filter: brightness(0.98);
        }

        /* Add column resize styles */
        .resize-handle {
            position: absolute;
            top: 0;
            right: -3px;
            width: 6px;
            height: 100%;
            cursor: col-resize;
            z-index: 11;
            background: transparent;
            transition: background-color 0.2s;
        }

        .resize-handle:hover,
        .resize-handle.active {
            background-color: #1a73e8;
            width: 4px;
            right: -2px;
        }

        /* Make resize handles more visible on header hover */
        th:hover .resize-handle {
            background-color: #dadce0;
        }

        th {
            position: relative;  /* For resize handle positioning */
        }

        .table-container.resizing {
            cursor: col-resize;
            user-select: none;
        }

        /* Bottom sheet styles */
        .bottom-sheet {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: white;
            border-top-left-radius: 12px;
            border-top-right-radius: 12px;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
            transform: translateY(100%);
            transition: transform 0.3s ease-out;
            z-index: 1000;
            max-height: 80vh;
            overflow-y: auto;
        }

        .bottom-sheet.open {
            transform: translateY(0);
        }

        .sheet-drag-handle {
            width: 40px;
            height: 4px;
            background-color: #e0e0e0;
            border-radius: 2px;
            margin: 8px auto;
        }

        .bottom-sheet-header {
            padding: 16px;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .bottom-sheet-content {
            padding: 16px;
        }

        /* Menu items */
        .menu-item {
            padding: 12px 16px;
            display: flex;
            align-items: center;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .menu-item:hover {
            background-color: #f5f5f5;
        }

        .menu-item i {
            margin-right: 12px;
            color: #5f6368;
        }
    </style>
</head>
<body>
    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th class="row-number">#</th>
                    <th>Test Case ID<div class="resize-handle"></div></th>
                    <th>Module<div class="resize-handle"></div></th>
                    <th>Test Case<div class="resize-handle"></div></th>
                    <th>Expected Outcome<div class="resize-handle"></div></th>
                    <th>Actual Outcome<div class="resize-handle"></div></th>
                    <th>Priority<div class="resize-handle"></div></th>
                    <th>Assigned To<div class="resize-handle"></div></th>
                    <th>Status<div class="resize-handle"></div></th>
                    <th>Execution Date<div class="resize-handle"></div></th>
                    <th>Test Result<div class="resize-handle"></div></th>
                    <th>Comments<div class="resize-handle"></div></th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for row in data %}
                <tr>
                    <td class="row-number">{{ loop.index }}</td>
                    <td class="editable" onclick="editCell(this)">{{ row["Test Case ID"] }}</td>
                    <td class="editable" onclick="editCell(this)">{{ row.Module }}</td>
                    <td class="editable" onclick="editCell(this)">{{ row["Test Case"] }}</td>
                    <td class="editable" onclick="editCell(this)">{{ row["Expected Outcome"] }}</td>
                    <td class="editable" onclick="editCell(this)">{{ row["Actual Outcome"] }}</td>
                    <td class="editable" onclick="editCell(this)">{{ row.Priority }}</td>
                    <td class="editable" onclick="editCell(this)">{{ row["Assigned To"] }}</td>
                    <td class="editable" onclick="editCell(this)">{{ row.Status }}</td>
                    <td class="editable" onclick="editCell(this)">{{ row["Execution Date"] }}</td>
                    <td class="editable" onclick="editCell(this)">{{ row["Test Result"] }}</td>
                    <td class="editable" onclick="editCell(this)">{{ row.Comments }}</td>
                    <td>
                        <button onclick="deleteRow(this)" class="delete-button">Delete</button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <div class="bottom-bar">
        <div class="sheet-hamburger" onclick="showWorksheetMenu(event)">
            <div class="sheet-hamburger-icon">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </div>
        <div class="sheets-container">
            {% for sheet in sheets %}
            <div class="sheet-tab {% if sheet == current_sheet %}active{% endif %}"
                data-sheet="{{ sheet }}"
                onclick="changeSheet('{{ sheet }}')"
                oncontextmenu="showSheetMenu(event, '{{ sheet }}'); return false;">
                {{ sheet }}
            </div>
            {% endfor %}
        </div>
        <button class="new-sheet-btn" onclick="showNewSheetDialog()">
            <span>+</span> Add Sheet
        </button>
    </div>

    <div id="sheetMenu" class="sheet-menu">
        <div class="sheet-menu-item" onclick="renameSheet()">
            <span>Rename</span>
        </div>
        <div class="sheet-menu-divider"></div>
        <div class="sheet-menu-item" onclick="duplicateSheet()">
            <span>Duplicate</span>
        </div>
        <div class="sheet-menu-divider"></div>
        <div class="sheet-menu-item danger" onclick="deleteSheet()">
            <span>Delete</span>
        </div>
    </div>

    <!-- Add color menu -->
    <div id="colorMenu" class="color-menu">
        <div class="color-option" style="background-color: #fce8e8;" onclick="setCellColor('red')"></div>
        <div class="color-option" style="background-color: #e6f4ea;" onclick="setCellColor('green')"></div>
        <div class="color-option" style="background-color: #fef7e0;" onclick="setCellColor('yellow')"></div>
        <div class="color-option" style="background-color: #e8f0fe;" onclick="setCellColor('blue')"></div>
        <div class="color-option" style="background-color: white;" onclick="setCellColor('')">❌</div>
    </div>

    <!-- Add worksheet menu -->
    <div id="worksheetMenu" class="worksheet-menu" style="display: none;">
        {% for sheet in sheets %}
        <div class="worksheet-menu-item {% if sheet == current_sheet %}active{% endif %}" 
            onclick="changeSheet('{{ sheet }}')">
            {{ sheet }}
        </div>
        {% endfor %}
    </div>

    <!-- Bottom Sheet -->
    <div class="bottom-sheet" id="menuBottomSheet">
        <div class="sheet-drag-handle"></div>
        <div class="bottom-sheet-header">
            <h3>Menu</h3>
            <button onclick="closeBottomSheet()" style="border: none; background: none; cursor: pointer;">✕</button>
        </div>
        <div class="bottom-sheet-content">
            <div class="menu-item" onclick="handleMenuAction('new')">
                <i>📄</i> New Sheet
            </div>
            <div class="menu-item" onclick="handleMenuAction('rename')">
                <i>✏️</i> Rename
            </div>
            <div class="menu-item" onclick="handleMenuAction('duplicate')">
                <i>📋</i> Make a copy
            </div>
            <div class="menu-item" onclick="handleMenuAction('delete')">
                <i>🗑️</i> Delete
            </div>
        </div>
    </div>

    <script>
        const sheetId = window.location.pathname.split('/').pop();
        let currentSheetData = {};
        let currentSheet = '{{ current_sheet }}';

        async function editCell(cell) {
            if (cell.classList.contains('editing')) return;

            // Store original content and styles
            const originalContent = cell.textContent;
            const originalStyles = window.getComputedStyle(cell);

            // Create input with exact same styling as the cell
            const input = document.createElement('input');
            input.value = originalContent;
            input.style.cssText = `
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                padding: ${originalStyles.padding};
                font: ${originalStyles.font};
                color: ${originalStyles.color};
                background: white;
                border: none;
                outline: none;
                box-sizing: border-box;
                z-index: 1;
            `;

            // Add editing class but keep original text visible
            cell.classList.add('editing');
            cell.appendChild(input);

            // Focus input
            input.focus();
            input.select();

            const finishEditing = async (newValue, moveTo = null) => {
                // Remove input first
                input.remove();
                
                // Update content
                cell.textContent = newValue;
                cell.classList.remove('editing');

                // Send update to server
                const rowIndex = cell.parentElement.rowIndex;
                const colIndex = cell.cellIndex - 1;
                const range = `${String.fromCharCode(65 + colIndex)}${rowIndex}`;

                try {
                    const response = await fetch(`/api/v1/sheets/{{ platform.lower() }}/${sheetId}/cell`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ range, value: newValue })
                    });

                    if (!response.ok) {
                        cell.textContent = originalContent;
                    }
                } catch (error) {
                    console.error('Error:', error);
                    cell.textContent = originalContent;
                }

                // Move to next cell if specified
                if (moveTo) {
                    editCell(moveTo);
                }
            };

            // Handle blur event
            input.addEventListener('blur', () => {
                finishEditing(input.value);
            });

            // Handle keyboard navigation
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Tab' || e.key === 'Enter') {
                    e.preventDefault();
                    
                    const currentRow = cell.parentElement;
                    let nextCell = null;

                    if (e.key === 'Enter') {
                        // Move down
                        const nextRow = currentRow.nextElementSibling;
                        if (nextRow) {
                            nextCell = nextRow.cells[cell.cellIndex];
                        }
                    } else {
                        // Tab navigation
                        nextCell = e.shiftKey 
                            ? cell.previousElementSibling 
                            : cell.nextElementSibling;

                        if (!nextCell && !e.shiftKey && currentRow.nextElementSibling) {
                            const nextRow = currentRow.nextElementSibling;
                            nextCell = nextRow.querySelector('.editable');
                        } else if (!nextCell && e.shiftKey && currentRow.previousElementSibling) {
                            const prevRow = currentRow.previousElementSibling;
                            const editableCells = prevRow.querySelectorAll('.editable');
                            nextCell = editableCells[editableCells.length - 1];
                        }
                    }

                    if (nextCell && nextCell.classList.contains('editable')) {
                        finishEditing(input.value, nextCell);
                    } else {
                        finishEditing(input.value);
                    }
                }
            });
        }

        function updateTableContent(data) {
            const tbody = document.querySelector('tbody');
            tbody.innerHTML = '';

            // If no data, show empty state with no headers
            if (!data || data.length === 0) {
                addEmptyRows();
                return;
            }

            // Skip the header row if it exists
            const startIndex = data[0]["Test Case ID"] === "Test Case ID" ? 1 : 0;

            data.slice(startIndex).forEach((row, index) => {
                const tr = document.createElement('tr');
                
                // Add row number
                const rowNum = document.createElement('td');
                rowNum.className = 'row-number';
                rowNum.textContent = index + 1;
                tr.appendChild(rowNum);

                // Add data cells
                [
                    "Test Case ID", "Module", "Test Case", "Expected Outcome",
                    "Actual Outcome", "Priority", "Assigned To", "Status",
                    "Execution Date", "Test Result", "Comments"
                ].forEach(key => {
                    const td = document.createElement('td');
                    td.className = 'editable';
                    td.onclick = function() { editCell(this); };
                    td.textContent = row[key] || '';
                    tr.appendChild(td);
                });

                // Add delete button
                const actionTd = document.createElement('td');
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'delete-button';
                deleteBtn.onclick = function() { deleteRow(this); };
                deleteBtn.textContent = 'Delete';
                actionTd.appendChild(deleteBtn);
                tr.appendChild(actionTd);

                tbody.appendChild(tr);
            });

            addEmptyRows();
        }

        let activeSheetName = '';

        async function changeSheet(sheetName) {
            if (sheetName === currentSheet) return;

            try {
                const response = await fetch(`/api/v1/sheets/{{ platform.lower() }}/data/${sheetId}?sheet_name=${sheetName}`);
                
                if (!response.ok) throw new Error('Failed to fetch sheet data');
                
                const result = await response.json();
                currentSheetData = result.data;
                currentSheet = sheetName;

                // Update URL without reload
                const url = new URL(window.location);
                url.searchParams.set('sheet_name', sheetName);
                window.history.pushState({}, '', url);

                // Update table content and sheet tabs
                updateTableContent(result.data);
                updateSheetTabs(sheetName);
            } catch (error) {
                console.error('Error changing sheet:', error);
                alert('Failed to switch to sheet: ' + sheetName);
            }
        }

        function showSheetMenu(event, sheetName) {
            closeSheetMenu();
            
            const menu = document.getElementById('sheetMenu');
            const rect = event.target.getBoundingClientRect();
            
            menu.style.display = 'block';
            
            let left = rect.left;
            let top = rect.bottom + 5;  // Show menu below the tab instead of above
            
            // Adjust if menu would go off screen
            if (left + menu.offsetWidth > window.innerWidth) {
                left = window.innerWidth - menu.offsetWidth - 10;
            }
            if (top + menu.offsetHeight > window.innerHeight - 50) {
                top = rect.top - menu.offsetHeight - 5;  // Show above if no space below
            }
            
            menu.style.left = `${left}px`;
            menu.style.top = `${top}px`;
            
            activeSheetName = sheetName;
            event.preventDefault();
            
            // Add click listener with delay
            setTimeout(() => {
                document.addEventListener('click', closeSheetMenu);
            }, 0);
            
            return false;
        }

        function closeSheetMenu() {
            document.getElementById('sheetMenu').style.display = 'none';
            document.removeEventListener('click', closeSheetMenu);
        }

        async function renameSheet() {
            const tab = document.querySelector(`.sheet-tab[data-sheet="${activeSheetName}"]`);
            const input = document.createElement('input');
            input.className = 'rename-input';
            input.value = activeSheetName;
            
            // Save original content in case of cancel
            const originalName = activeSheetName;
            
            // Replace tab content with input
            tab.textContent = '';
            tab.appendChild(input);
            input.focus();
            input.select();
            
            const handleRename = async () => {
                const newName = input.value.trim();
                if (newName && newName !== originalName) {
                    try {
                        const response = await fetch(`/api/v1/sheets/{{ platform.lower() }}/${sheetId}/rename`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                old_name: originalName,
                                new_name: newName
                            })
                        });

                        if (response.ok) {
                            tab.textContent = newName;
                            tab.setAttribute('data-sheet', newName);
                            
                            if (originalName === currentSheet) {
                                currentSheet = newName;
                                const url = new URL(window.location);
                                url.searchParams.set('sheet_name', newName);
                                window.history.pushState({}, '', url);
                            }
                        } else {
                            tab.textContent = originalName;
                            alert('Failed to rename sheet');
                        }
                    } catch (error) {
                        console.error('Error:', error);
                        tab.textContent = originalName;
                    }
                } else {
                    tab.textContent = originalName;
                }
            };

            // Handle Enter key and blur
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    input.blur();
                } else if (e.key === 'Escape') {
                    tab.textContent = originalName;
                    closeSheetMenu();
                }
            });

            input.addEventListener('blur', handleRename);
            closeSheetMenu();
        }

        async function duplicateSheet() {
            const newName = prompt('Enter name for the duplicate sheet:', `${activeSheetName} (Copy)`);
            if (newName) {
                try {
                    const response = await fetch(`/api/v1/sheets/{{ platform.lower() }}/${sheetId}/duplicate`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            source_name: activeSheetName,
                            new_name: newName
                        })
                    });

                    if (response.ok) {
                        // Add new tab without reload
                        const sheetsContainer = document.querySelector('.sheets-container');
                        const newTab = document.createElement('div');
                        newTab.className = 'sheet-tab';
                        newTab.setAttribute('data-sheet', newName);
                        newTab.onclick = () => changeSheet(newName);
                        newTab.oncontextmenu = (e) => showSheetMenu(e, newName);
                        newTab.textContent = newName;
                        sheetsContainer.appendChild(newTab);
                        
                        // Switch to new sheet
                        changeSheet(newName);
                    } else {
                        alert('Failed to duplicate sheet');
                    }
                } catch (error) {
                    console.error('Error:', error);
                }
            }
            closeSheetMenu();
        }

        async function deleteSheet() {
            try {
                const response = await fetch(`/api/v1/sheets/{{ platform.lower() }}/${sheetId}/sheet/${activeSheetName}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    const tab = document.querySelector(`.sheet-tab[data-sheet="${activeSheetName}"]`);
                    
                    // Animate removal
                    tab.style.transition = 'all 0.2s';
                    tab.style.opacity = '0';
                    tab.style.transform = 'translateY(10px)';
                    
                    setTimeout(() => {
                        tab.remove();
                        
                        // Switch to first available sheet if current sheet was deleted
                        if (activeSheetName === currentSheet) {
                            const firstSheet = document.querySelector('.sheet-tab');
                            if (firstSheet) {
                                changeSheet(firstSheet.getAttribute('data-sheet'));
                            }
                        }
                    }, 200);
                } else {
                    alert('Failed to delete sheet');
                }
            } catch (error) {
                console.error('Error:', error);
            }
            closeSheetMenu();
        }

        function showNewSheetDialog() {
            createNewSheet();
        }

        async function createNewSheet() {
            // Get all existing sheet names
            const existingSheets = {{ sheets|tojson|safe }};
            
            // Extract numbers from existing sheet names
            const usedNumbers = existingSheets
                .map(name => {
                    const match = name.match(/Sheet(\d+)/);
                    return match ? parseInt(match[1]) : 0;
                })
                .filter(num => !isNaN(num));
            
            // Find the lowest available number
            let counter = 1;
            while (usedNumbers.includes(counter)) {
                counter++;
            }
            
            const sheetName = `Sheet${counter}`;

            try {
                const response = await fetch(`/api/v1/sheets/{{ platform.lower() }}/${sheetId}/new-sheet`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ title: sheetName })
                });

                if (response.ok) {
                    // Add new tab without reload
                    const sheetsContainer = document.querySelector('.sheets-container');
                    
                    // Find the correct position to insert the new tab
                    const newNumber = counter;
                    let insertBefore = null;
                    
                    for (const tab of sheetsContainer.children) {
                        const match = tab.textContent.match(/Sheet(\d+)/);
                        if (match && parseInt(match[1]) > newNumber) {
                            insertBefore = tab;
                            break;
                        }
                    }

                    const newTab = document.createElement('div');
                    newTab.className = 'sheet-tab active';
                    newTab.setAttribute('data-sheet', sheetName);
                    newTab.onclick = () => changeSheet(sheetName);
                    newTab.oncontextmenu = (e) => showSheetMenu(e, sheetName);
                    newTab.textContent = sheetName;
                    
                    // Remove active class from other tabs
                    document.querySelectorAll('.sheet-tab.active').forEach(tab => {
                        tab.classList.remove('active');
                    });
                    
                    if (insertBefore) {
                        sheetsContainer.insertBefore(newTab, insertBefore);
                    } else {
                        sheetsContainer.appendChild(newTab);
                    }

                    // Initialize empty sheet data
                    currentSheet = sheetName;
                    currentSheetData = { data: [] };
                    updateTableContent([]);
                    
                    // Update URL
                    const url = new URL(window.location);
                    url.searchParams.set('sheet_name', sheetName);
                    window.history.pushState({}, '', url);
                } else {
                    const error = await response.json();
                    console.error('Error:', error);
                    
                    if (error.detail && error.detail.includes('already exists')) {
                        counter++;
                        createNewSheet();
                        return;
                    }
                    
                    alert(error.detail || 'Failed to create sheet');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Failed to create sheet');
            }
        }

        async function deleteRow(button) {
            const row = button.closest('tr');
            const rowIndex = row.rowIndex;
            
            if (!confirm('Are you sure you want to delete this row?')) return;

            try {
                const response = await fetch(`/api/v1/sheets/{{ platform.lower() }}/${sheetId}/row/${rowIndex}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    row.remove();  // Remove the row from the table immediately
                } else {
                    alert('Failed to delete row');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Failed to delete row');
            }
        }

        let activeCell = null;

        // Add context menu for color options
        document.addEventListener('contextmenu', (e) => {
            const cell = e.target.closest('.editable');
            if (!cell) return;

            e.preventDefault();
            const menu = document.getElementById('colorMenu');
            
            // Calculate position to keep menu in viewport
            let left = e.pageX;
            let top = e.pageY;
            
            const menuWidth = 150;  // Approximate menu width
            const menuHeight = 120; // Approximate menu height
            
            if (left + menuWidth > window.innerWidth) {
                left = window.innerWidth - menuWidth - 10;
            }
            
            if (top + menuHeight > window.innerHeight) {
                top = window.innerHeight - menuHeight - 10;
            }
            
            menu.style.left = `${left}px`;
            menu.style.top = `${top}px`;
            menu.style.display = 'block';
            
            activeCell = cell;
        });

        // Close color menu when clicking outside
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.color-menu')) {
                document.getElementById('colorMenu').style.display = 'none';
            }
        });

        async function setCellColor(color) {
            if (!activeCell) return;
            
            // Remove existing color classes
            activeCell.classList.remove('bg-red', 'bg-green', 'bg-yellow', 'bg-blue');
            
            // Add new color class if color is specified
            if (color) {
                activeCell.classList.add(`bg-${color}`);
            }

            // Get cell position
            const rowIndex = activeCell.parentElement.rowIndex;
            const colIndex = activeCell.cellIndex;
            const range = `${String.fromCharCode(65 + colIndex)}${rowIndex + 1}`;

            try {
                // Update cell format in local database
                const response = await fetch(`/api/v1/sheets/{{ platform.lower() }}/${sheetId}/format`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        range: range,
                        format: { backgroundColor: color }
                    })
                });

                if (!response.ok) {
                    throw new Error('Failed to update cell format');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Failed to update cell color');
            }

            document.getElementById('colorMenu').style.display = 'none';
        }

        // Prevent scroll position changes when clicking
        document.addEventListener('click', (e) => {
            if (e.target.closest('.editable')) {
                e.preventDefault();
            }
        }, { capture: true });

        // Update table container styles
        document.querySelector('.table-container').style.scrollBehavior = 'smooth';

        // Add empty rows dynamically
        function addEmptyRows() {
            const tbody = document.querySelector('tbody');
            const currentRows = tbody.children.length;
            const targetRows = 300;  // Show all 300 rows
            
            // Calculate how many actual data rows we have
            const dataRows = document.querySelectorAll('tbody tr:not(.empty-row):not(.end-of-table)').length;
            
            // Remove existing end indicator if any
            const existingIndicator = document.querySelector('.end-of-table');
            if (existingIndicator) {
                existingIndicator.remove();
            }

            if (dataRows < targetRows) {
                const fragment = document.createDocumentFragment();
                for (let i = dataRows; i < targetRows; i++) {
                    const tr = document.createElement('tr');
                    tr.className = 'empty-row';
                    
                    // Add row number
                    const rowNum = document.createElement('td');
                    rowNum.className = 'row-number';
                    rowNum.textContent = i + 1;
                    tr.appendChild(rowNum);
                    
                    // Add empty cells
                    for (let j = 0; j < 12; j++) {
                        const td = document.createElement('td');
                        td.className = 'editable';
                        td.onclick = function() { editCell(this); };
                        td.textContent = '';
                        tr.appendChild(td);
                    }
                    fragment.appendChild(tr);
                }
                tbody.appendChild(fragment);

                // Add end of table indicator
                const endRow = document.createElement('tr');
                const endCell = document.createElement('td');
                endCell.colSpan = 13;
                endCell.className = 'end-of-table';
                endCell.textContent = 'End of table - Maximum 300 rows';
                endRow.appendChild(endCell);
                tbody.appendChild(endRow);
            }
        }

        // Call addEmptyRows on page load
        document.addEventListener('DOMContentLoaded', () => {
            addEmptyRows();
        });

        // Update scroll handler
        document.querySelector('.table-container').addEventListener('scroll', function(e) {
            const { scrollTop, scrollHeight, clientHeight } = e.target;
            
            clearTimeout(scrollTimeout);
            
            scrollTimeout = setTimeout(() => {
                const tbody = document.querySelector('tbody');
                const dataRows = document.querySelectorAll('tbody tr:not(.empty-row):not(.end-of-table)').length;
                if (dataRows < 300 && scrollHeight - scrollTop - clientHeight < 200) {
                    addEmptyRows();
                }
            }, 100);
        });

        // Update sheet tabs to show active state correctly
        function updateSheetTabs(activeName) {
            document.querySelectorAll('.sheet-tab').forEach(tab => {
                if (tab.getAttribute('data-sheet') === activeName) {
                    tab.classList.add('active');
                } else {
                    tab.classList.remove('active');
                }
            });
        }

        function showWorksheetMenu(event) {
            const menu = document.getElementById('worksheetMenu');
            const rect = event.target.closest('.sheet-hamburger').getBoundingClientRect();
            
            // Close any other open menus
            closeSheetMenu();
            
            menu.style.display = 'block';
            menu.style.left = '20px';  // Fixed left position
            menu.style.top = `${rect.bottom + 4}px`;
            
            // Adjust position if menu would go off screen
            const menuRect = menu.getBoundingClientRect();
            if (menuRect.bottom > window.innerHeight) {
                menu.style.top = `${rect.top - menuRect.height - 4}px`;
            }
            
            event.stopPropagation();
            
            setTimeout(() => {
                document.addEventListener('click', closeWorksheetMenu);
            }, 0);
        }

        function closeWorksheetMenu() {
            document.getElementById('worksheetMenu').style.display = 'none';
            document.removeEventListener('click', closeWorksheetMenu);
        }

        let isDragging = false;
        let startCell = null;
        let currentCell = null;
        let selection = null;

        function initDragToExtend() {
            const table = document.querySelector('table');
            
            // Create selection element
            selection = document.createElement('div');
            selection.className = 'cell-selection';
            selection.style.display = 'none';
            document.querySelector('.table-container').appendChild(selection);

            // Add drag handle to each editable cell
            document.querySelectorAll('.editable').forEach(cell => {
                const handle = document.createElement('div');
                handle.className = 'drag-handle';
                cell.appendChild(handle);

                handle.addEventListener('mousedown', (e) => {
                    e.stopPropagation();
                    isDragging = true;
                    startCell = cell;
                    currentCell = cell;
                    updateSelection();
                });
            });

            // Handle mouse move for selection
            document.addEventListener('mousemove', (e) => {
                if (!isDragging) return;

                const cell = document.elementFromPoint(e.clientX, e.clientY);
                if (cell && cell.classList.contains('editable')) {
                    currentCell = cell;
                    updateSelection();
                }
            });

            // Handle mouse up to end selection
            document.addEventListener('mouseup', () => {
                if (isDragging) {
                    isDragging = false;
                    if (startCell && currentCell) {
                        extendValues();
                    }
                    selection.style.display = 'none';
                }
            });
        }

        function updateSelection() {
            if (!startCell || !currentCell) return;

            const startRect = startCell.getBoundingClientRect();
            const currentRect = currentCell.getBoundingClientRect();
            const containerRect = document.querySelector('.table-container').getBoundingClientRect();

            const left = Math.min(startRect.left, currentRect.left) - containerRect.left;
            const top = Math.min(startRect.top, currentRect.top) - containerRect.top;
            const width = Math.abs(currentRect.left - startRect.left) + currentRect.width;
            const height = Math.abs(currentRect.top - startRect.top) + currentRect.height;

            selection.style.display = 'block';
            selection.style.left = `${left}px`;
            selection.style.top = `${top}px`;
            selection.style.width = `${width}px`;
            selection.style.height = `${height}px`;
        }

        function extendValues() {
            const startIndex = startCell.cellIndex;
            const startRow = startCell.parentElement.rowIndex;
            const endIndex = currentCell.cellIndex;
            const endRow = currentCell.parentElement.rowIndex;

            const startValue = startCell.textContent;

            // Get all cells in selection
            const cells = [];
            for (let i = Math.min(startRow, endRow); i <= Math.max(startRow, endRow); i++) {
                for (let j = Math.min(startIndex, endIndex); j <= Math.max(startIndex, endIndex); j++) {
                    const cell = document.querySelector(`tr:nth-child(${i + 1}) td:nth-child(${j + 1})`);
                    if (cell && cell !== startCell) {
                        cells.push(cell);
                    }
                }
            }

            // Update all cells with the start value
            cells.forEach(cell => {
                cell.textContent = startValue;
                // Trigger cell update to backend
                const range = `${String.fromCharCode(65 + cell.cellIndex - 1)}${cell.parentElement.rowIndex}`;
                updateCellValue(range, startValue);
            });
        }

        async function updateCellValue(range, value) {
            try {
                await fetch(`/api/v1/sheets/{{ platform.lower() }}/${sheetId}/cell`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ range, value })
                });
            } catch (error) {
                console.error('Error updating cell:', error);
            }
        }

        // Initialize drag to extend functionality
        document.addEventListener('DOMContentLoaded', initDragToExtend);

        function initColumnResize() {
            const table = document.querySelector('table');
            const headers = table.querySelectorAll('th');
            let isResizing = false;
            let currentHeader = null;
            let startX;
            let startWidth;

            // Add resize handles to all headers except the last one
            headers.forEach((header, index) => {
                if (index < headers.length - 1) {  // Skip last column
                    const handle = document.createElement('div');
                    handle.className = 'resize-handle';
                    header.appendChild(handle);

                    handle.addEventListener('mousedown', startResize);
                }
            });

            function startResize(e) {
                isResizing = true;
                currentHeader = e.target.parentElement;
                startX = e.pageX;
                startWidth = currentHeader.offsetWidth;

                // Add resizing class for visual feedback
                document.querySelector('.table-container').classList.add('resizing');
                e.target.classList.add('active');

                document.addEventListener('mousemove', resize);
                document.addEventListener('mouseup', stopResize);

                e.preventDefault(); // Prevent text selection
            }

            function resize(e) {
                if (!isResizing) return;

                const diff = e.pageX - startX;
                const newWidth = Math.max(50, startWidth + diff); // Minimum width of 50px
                
                // Update column width
                currentHeader.style.width = `${newWidth}px`;
                
                // Update all cells in this column
                const colIndex = Array.from(currentHeader.parentElement.children).indexOf(currentHeader);
                const cells = table.querySelectorAll(`td:nth-child(${colIndex + 1})`);
                cells.forEach(cell => {
                    cell.style.width = `${newWidth}px`;
                });
            }

            function stopResize() {
                if (!isResizing) return;

                isResizing = false;
                document.querySelector('.table-container').classList.remove('resizing');
                document.querySelectorAll('.resize-handle.active').forEach(handle => {
                    handle.classList.remove('active');
                });

                document.removeEventListener('mousemove', resize);
                document.removeEventListener('mouseup', stopResize);
            }
        }

        // Initialize column resize on page load
        document.addEventListener('DOMContentLoaded', () => {
            initColumnResize();
        });

        function openBottomSheet() {
            document.getElementById('menuBottomSheet').classList.add('open');
        }

        function closeBottomSheet() {
            document.getElementById('menuBottomSheet').classList.remove('open');
        }

        function handleMenuAction(action) {
            const sheetId = '{{ sheet_id }}';
            switch(action) {
                case 'new':
                    // Call your API endpoint for creating new sheet
                    break;
                case 'rename':
                    // Call your API endpoint for renaming
                    break;
                case 'duplicate':
                    // Call your API endpoint for duplicating
                    break;
                case 'delete':
                    if (confirm('Are you sure you want to delete this sheet?')) {
                        // Call your API endpoint for deleting
                    }
                    break;
            }
            closeBottomSheet();
        }

        // Close sheet when clicking outside
        document.addEventListener('click', (e) => {
            const sheet = document.getElementById('menuBottomSheet');
            if (!sheet.contains(e.target)) {
                closeBottomSheet();
            }
        });

        // Add drag to dismiss functionality
        let startY;
        let currentY;
        const sheet = document.getElementById('menuBottomSheet');

        sheet.addEventListener('touchstart', (e) => {
            startY = e.touches[0].clientY;
        });

        sheet.addEventListener('touchmove', (e) => {
            currentY = e.touches[0].clientY;
            const diff = currentY - startY;
            if (diff > 0) { // Only allow dragging down
                sheet.style.transform = `translateY(${diff}px)`;
            }
        });

        sheet.addEventListener('touchend', () => {
            if (currentY - startY > 100) { // If dragged down more than 100px
                closeBottomSheet();
            } else {
                sheet.style.transform = '';
            }
        });
    </script>
</body>
</html> 